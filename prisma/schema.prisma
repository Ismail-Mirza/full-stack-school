generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id       String @id
  username String @unique
}

model Student {
  id          String       @id
  username    String       @unique
  name        String
  surname     String
  email       String?      @unique
  phone       String?      @unique
  address     String
  img         String?
  bloodType   String
  sex         UserSex
  createdAt   DateTime     @default(now())
  parentId    String
  parent      Parent       @relation(fields: [parentId], references: [id])
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  gradeId     Int
  grade       Grade        @relation(fields: [gradeId], references: [id])
  attendances Attendance[]
  results     Result[]
  birthday    DateTime
}

model Teacher {
  id        String    @id
  username  String    @unique
  name      String
  surname   String
  email     String?   @unique
  phone     String?   @unique
  address   String
  img       String?
  bloodType String
  sex       UserSex
  createdAt DateTime  @default(now())
  subjects  Subject[]
  lessons   Lesson[]
  classes   Class[]
  birthday  DateTime
}

model Parent {
  id        String    @id
  username  String    @unique
  name      String
  surname   String
  email     String?   @unique
  phone     String    @unique
  address   String
  createdAt DateTime  @default(now())
  students  Student[]
}

model Grade {
  id    Int @id @default(autoincrement())
  level Int @unique

  students Student[]
  classess Class[]
}

model Class {
  id       Int    @id @default(autoincrement())
  name     String @unique
  capacity Int

  supervisorId  String?
  supervisor    Teacher?       @relation(fields: [supervisorId], references: [id])
  lessons       Lesson[]
  students      Student[]
  gradeId       Int
  grade         Grade          @relation(fields: [gradeId], references: [id])
  events        Event[]
  announcements Announcement[]
}

model Subject {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  teachers Teacher[]
  lessons  Lesson[]
}

model Lesson {
  id        Int      @id @default(autoincrement())
  name      String
  day       Day
  startTime DateTime
  endTime   DateTime

  subjectId   Int
  subject     Subject      @relation(fields: [subjectId], references: [id])
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  teacherId   String
  teacher     Teacher      @relation(fields: [teacherId], references: [id])
  exams       Exam[]
  assignments Assignment[]
  attendances Attendance[]
}

model Exam {
  id        Int      @id @default(autoincrement())
  title     String
  startTime DateTime
  endTime   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Assignment {
  id        Int      @id @default(autoincrement())
  title     String
  startDate DateTime
  dueDate   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Result {
  id    Int @id @default(autoincrement())
  score Int

  examId       Int?
  exam         Exam?       @relation(fields: [examId], references: [id])
  assignmentId Int?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  studentId    String
  student      Student     @relation(fields: [studentId], references: [id])
}

model Attendance {
  id      Int      @id @default(autoincrement())
  date    DateTime
  present Boolean

  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  lessonId  Int
  lesson    Lesson  @relation(fields: [lessonId], references: [id])
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  startTime   DateTime
  endTime     DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

model Announcement {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  date        DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

enum UserSex {
  MALE
  FEMALE
}

enum Day {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
}

// ============================================
// AI PLAYGROUND - RAG SYSTEM MODELS
// ============================================

// Document storage for RAG knowledge base
model AIDocument {
  id          String   @id @default(cuid())
  title       String
  description String?
  fileUrl     String?  // Cloudinary URL
  fileType    String   // pdf, docx, txt, md, etc.
  subject     String?  // math, physics, chemistry, etc.
  gradeLevel  Int?     // 1-12
  uploadedBy  String   // Clerk user ID
  uploadedByRole String // teacher, admin
  isPublic    Boolean  @default(true) // visible to students
  metadata    Json?    // custom metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chunks      AIDocumentChunk[]
  classId     Int?
  class       Class?   @relation(fields: [classId], references: [id])
  subjectId   Int?
  subject_rel Subject? @relation(fields: [subjectId], references: [id])

  @@index([subject, gradeLevel])
  @@index([uploadedBy])
}

// Chunked documents with embeddings for vector search
model AIDocumentChunk {
  id          String   @id @default(cuid())
  documentId  String
  document    AIDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  content     String   @db.Text
  embedding   String?  @db.Text // JSON stringified vector
  chunkIndex  Int
  metadata    Json?    // page number, section, etc.
  createdAt   DateTime @default(now())

  @@index([documentId])
}

// Conversation sessions
model AIConversation {
  id              String   @id @default(cuid())
  userId          String   // Clerk user ID
  userRole        String   // teacher, student
  title           String
  mode            String   // research, math_solver, physics_solver, chemistry_solver, quiz_creator, exam_creator
  subject         String?
  gradeLevel      Int?
  isActive        Boolean  @default(true)
  metadata        Json?    // context, settings
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  messages        AIMessage[]
  feedback        AIFeedback[]
  generatedContent AIGeneratedContent[]

  @@index([userId, isActive])
  @@index([mode, subject])
}

// Individual messages in conversation
model AIMessage {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role            String   // user, assistant, system, tool
  content         String   @db.Text
  toolCalls       Json?    // function calls, tool usage
  retrievedDocs   Json?    // documents used in RAG
  confidence      Float?   // model confidence score
  metadata        Json?
  createdAt       DateTime @default(now())

  feedback        AIFeedback[]

  @@index([conversationId])
}

// Self-learning feedback system
model AIFeedback {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  messageId       String?
  message         AIMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId          String
  feedbackType    String   // thumbs_up, thumbs_down, correction, rating
  rating          Int?     // 1-5
  comment         String?  @db.Text
  correctedAnswer String?  @db.Text
  wasUsedForLearning Boolean @default(false)
  createdAt       DateTime @default(now())

  @@index([conversationId])
  @@index([feedbackType, wasUsedForLearning])
}

// Generated content (slides, posters, quizzes, exams)
model AIGeneratedContent {
  id              String   @id @default(cuid())
  conversationId  String?
  conversation    AIConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  createdBy       String   // Clerk user ID
  type            String   // slide, poster, quiz, exam
  title           String
  content         Json     // structured content
  format          String?  // pdf, pptx, png, json
  fileUrl         String?  // exported file URL
  subject         String?
  gradeLevel      Int?
  difficulty      String?  // easy, medium, hard
  metadata        Json?
  isPublished     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Link to exam system for teacher-created quizzes
  examId          Int?     @unique
  exam            Exam?    @relation(fields: [examId], references: [id])

  @@index([createdBy, type])
  @@index([subject, gradeLevel])
}

// Analytics for self-learning improvements
model AIAnalytics {
  id              String   @id @default(cuid())
  userId          String?
  eventType       String   // query, retrieval, generation, feedback
  subject         String?
  mode            String?
  queryText       String?  @db.Text
  documentsRetrieved Int?
  responseTime    Int?     // milliseconds
  tokenUsage      Int?
  success         Boolean  @default(true)
  errorMessage    String?  @db.Text
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([eventType, createdAt])
  @@index([userId, createdAt])
}

// Query refinement for self-learning
model AIQueryRefinement {
  id              String   @id @default(cuid())
  originalQuery   String   @db.Text
  refinedQuery    String   @db.Text
  subject         String?
  mode            String
  improvementScore Float?  // how much better the refined query performed
  usageCount      Int      @default(0)
  lastUsed        DateTime?
  createdAt       DateTime @default(now())

  @@index([subject, mode])
  @@index([usageCount])
}
